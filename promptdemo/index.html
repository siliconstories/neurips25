<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Few-shot Dialogue:<br>Prompt Example</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-scroll::-webkit-scrollbar { width: 6px; opacity: 0; transition: opacity 0.3s; }
        .chat-scroll:hover::-webkit-scrollbar { opacity: 1; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes typing { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-6xl">
        <div id="initialState" class="max-w-md mx-auto space-y-6 fade-in">
            <h1 class="text-3xl font-light text-center mb-8 text-gray-100">Few-shot Dialogue:<br>Prompt Example</h1>
            <div class="space-y-2">
                <label class="text-sm text-gray-400">Select Provider</label>
                <select id="providerSelect" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors">
                    <option value="google">Google (Gemini 1.5 Pro)</option>
                    <option value="openai">OpenAI (ChatGPT-4o)</option>
                    <option value="anthropic">Anthropic (Claude Opus)</option>
                </select>
            </div>
            <div class="space-y-2 relative">
                <div class="flex items-center justify-between">
                    <label class="text-sm text-gray-400">API Key</label>
                    <button id="infoButton" class="text-gray-500 hover:text-gray-300 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
                <input id="apiKeyInput" type="password" placeholder="Enter your API key" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors">
                <div id="apiKeyStatus" class="text-xs text-center mt-2 h-4"></div>
                <div id="infoTooltip" class="hidden absolute mt-2 p-3 bg-gray-800 rounded-lg text-sm text-gray-300 shadow-lg z-10 w-64">Your API key is stored locally and never leaves your device except to communicate with the selected AI provider.</div>
            </div>
            <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center">
                <span id="startButtonText">Start</span>
                <svg id="startButtonSpinner" class="hidden animate-spin h-5 w-5 text-white ml-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
            <p class="text-center text-xs text-gray-500 mt-4">NeurIPS 2025 Art Track Submission</p>
        </div>
        <div id="chatState" class="hidden space-y-4 fade-in">
            <div class="flex justify-between items-center">
                <h1 id="sceneTitle" class="text-2xl font-light text-gray-100">Scene</h1>
                <div class="flex space-x-2">
                    <button id="restartChatBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm">Restart</button>
                    <button id="configureChatBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm">Configure</button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-900 rounded-xl border border-gray-800 flex flex-col h-[250px] lg:h-[600px]">
                    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                        <h2 class="font-medium text-gray-300">With Examples</h2>
                        <button id="infoWithExamplesBtn" class="text-gray-500 hover:text-gray-300 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </div>
                    <div id="leftChat" class="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll"></div>
                </div>
                <div class="bg-gray-900 rounded-xl border border-gray-800 flex flex-col h-[250px] lg:h-[600px]">
                    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                        <h2 class="font-medium text-gray-300">Without Examples</h2>
                        <button id="infoWithoutExamplesBtn" class="text-gray-500 hover:text-gray-300 transition-colors">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </div>
                    <div id="rightChat" class="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll"></div>
                </div>
            </div>
            <div class="bg-gray-900 rounded-xl border border-gray-700 p-4 focus-within:border-blue-500 transition-colors">
                <div class="flex items-center space-x-3">
                    <input id="messageInput" type="text" placeholder="Type your message..." class="flex-1 bg-transparent outline-none text-gray-100 placeholder-gray-500">
                    <button id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="promptWithExamplesPopup" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center"><h3 class="text-lg font-medium">Prompt: With Examples</h3><button id="closeWithExamplesBtn" class="text-gray-500 hover:text-gray-300">&times;</button></div>
            <pre id="promptWithExamplesContent" class="p-4 text-xs text-gray-300 overflow-auto whitespace-pre-wrap font-mono"></pre>
        </div>
    </div>
    <div id="promptWithoutExamplesPopup" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center"><h3 class="text-lg font-medium">Prompt: Without Examples</h3><button id="closeWithoutExamplesBtn" class="text-gray-500 hover:text-gray-300">&times;</button></div>
            <pre id="promptWithoutExamplesContent" class="p-4 text-xs text-gray-300 overflow-auto whitespace-pre-wrap font-mono"></pre>
        </div>
    </div>

    <script>
        // --- Core Configuration ---
        const SCENARIO_NAME = 'dreaming';
        
        const API_CONFIGS = {
            google: {
                url: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent',
                headers: (key) => ({ 'Content-Type': 'application/json', 'x-goog-api-key': key }),
                formatRequest: (messages, systemPrompt) => ({
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    contents: messages.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model',
                        parts: [{ text: msg.content.replace(/\*\*(Therapist|Patient):\*\*\s*/g, '') }]
                    })),
                    generationConfig: { temperature: 0.7, maxOutputTokens: 1000 }
                }),
                extractResponse: (data) => data.candidates[0].content.parts[0].text
            },
            openai: {
                url: 'https://api.openai.com/v1/chat/completions',
                headers: (key) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }),
                formatRequest: (messages, systemPrompt) => ({ model: 'gpt-4o', messages: [ { role: 'system', content: systemPrompt }, ...messages ], temperature: 0.7, stream: true }),
                extractResponse: (data) => data.choices[0].message.content
            },
            anthropic: {
                url: 'https://api.anthropic.com/v1/messages',
                headers: (key) => ({ 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01' }),
                formatRequest: (messages, systemPrompt) => ({ model: 'claude-3-opus-20240229', system: systemPrompt, messages: messages, max_tokens: 1000, temperature: 0.7, stream: true }),
                extractResponse: (data) => data.content[0].text
            }
        };

        // --- Prompts ---
        let PROMPT_WITH_EXAMPLES = 'Loading...';
        let PROMPT_WITHOUT_EXAMPLES = 'Loading...';

        // --- State Management ---
        let provider = 'google'; let apiKey = ''; let leftMessages = []; let rightMessages = []; let conversationStep = 0;

        // --- DOM Elements ---
        const initialState = document.getElementById('initialState'); const chatState = document.getElementById('chatState'); const providerSelect = document.getElementById('providerSelect'); const apiKeyInput = document.getElementById('apiKeyInput'); const startButton = document.getElementById('startButton'); const startButtonText = document.getElementById('startButtonText'); const startButtonSpinner = document.getElementById('startButtonSpinner'); const apiKeyStatus = document.getElementById('apiKeyStatus'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); const leftChat = document.getElementById('leftChat'); const rightChat = document.getElementById('rightChat'); const infoButton = document.getElementById('infoButton'); const infoTooltip = document.getElementById('infoTooltip'); const restartChatBtn = document.getElementById('restartChatBtn'); const configureChatBtn = document.getElementById('configureChatBtn'); const promptWithExamplesPopup = document.getElementById('promptWithExamplesPopup'); const promptWithoutExamplesPopup = document.getElementById('promptWithoutExamplesPopup'); const infoWithExamplesBtn = document.getElementById('infoWithExamplesBtn'); const infoWithoutExamplesBtn = document.getElementById('infoWithoutExamplesBtn'); const closeWithExamplesBtn = document.getElementById('closeWithExamplesBtn'); const closeWithoutExamplesBtn = document.getElementById('closeWithoutExamplesBtn'); const promptWithExamplesContent = document.getElementById('promptWithExamplesContent'); const promptWithoutExamplesContent = document.getElementById('promptWithoutExamplesContent'); const sceneTitle = document.getElementById('sceneTitle');

        // --- Initialization ---
        async function loadPrompts() {
            const baseUrl = `https://raw.githubusercontent.com/siliconstories/neurips25/main/promptdemo/promptfiles/`;
            const promptWithUrl = `${baseUrl}${SCENARIO_NAME}_with.txt`;
            const promptWithoutUrl = `${baseUrl}${SCENARIO_NAME}_without.txt`;

            try {
                const [responseWith, responseWithout] = await Promise.all([
                    fetch(promptWithUrl + '?t=' + new Date().getTime()),
                    fetch(promptWithoutUrl + '?t=' + new Date().getTime())
                ]);

                if (!responseWith.ok) throw new Error(`Failed to load ${SCENARIO_NAME}_with.txt (Status: ${responseWith.status})`);
                if (!responseWithout.ok) throw new Error(`Failed to load ${SCENARIO_NAME}_without.txt (Status: ${responseWithout.status})`);

                const [textWith, textWithout] = await Promise.all([ responseWith.text(), responseWithout.text() ]);

                PROMPT_WITH_EXAMPLES = textWith;
                PROMPT_WITHOUT_EXAMPLES = textWithout;

            } catch (error) {
                console.error("Failed to load prompts:", error);
                PROMPT_WITH_EXAMPLES = `Error: ${error.message}`;
                PROMPT_WITHOUT_EXAMPLES = `Error: ${error.message}`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            toggleStartButton(true, 'Loading Prompts...');
            await loadPrompts(); 
            loadSavedData();
            promptWithExamplesContent.textContent = PROMPT_WITH_EXAMPLES;
            promptWithoutExamplesContent.textContent = PROMPT_WITHOUT_EXAMPLES;
            sceneTitle.textContent = `Scene «${SCENARIO_NAME.charAt(0).toUpperCase() + SCENARIO_NAME.slice(1)}»`;

            if (PROMPT_WITH_EXAMPLES.startsWith("Error:")) {
                setStatusMessage('Critical Error: Could not load prompt files.', 'text-red-400');
                toggleStartButton(true, 'Error: Refresh');
            } else {
                setStatusMessage('', '');
                toggleStartButton(false, 'Start');
            }
        });

        function loadSavedData() {
            const savedProvider = localStorage.getItem('chatProvider'); const savedKey = localStorage.getItem('chatApiKey');
            if (savedProvider) { providerSelect.value = savedProvider; provider = savedProvider; }
            if (savedKey) { apiKeyInput.value = atob(savedKey); apiKey = atob(savedKey); }
        }

        // --- Event Listeners ---
        providerSelect.addEventListener('change', (e) => { provider = e.target.value; localStorage.setItem('chatProvider', provider); });
        apiKeyInput.addEventListener('input', (e) => { apiKey = e.target.value; localStorage.setItem('chatApiKey', btoa(apiKey)); });
        infoButton.addEventListener('mouseenter', () => infoTooltip.classList.remove('hidden'));
        infoButton.addEventListener('mouseleave', () => infoTooltip.classList.add('hidden'));

        // --- API Key Validation and Start ---
        function setStatusMessage(message, colorClass) { apiKeyStatus.textContent = message; apiKeyStatus.className = `text-xs text-center mt-2 h-4 ${colorClass}`; }
        function toggleStartButton(loading, text = 'Start') { startButton.disabled = loading; startButtonText.textContent = text; loading ? startButtonSpinner.classList.remove('hidden') : startButtonSpinner.classList.add('hidden'); }
        
        async function verifyApiKey(provider, key) {
            let url, options;
            const prefixes = { google: 'AIzaSy', openai: 'sk-', anthropic: 'sk-ant-api03-' };
            if (!key || !prefixes[provider] || !key.startsWith(prefixes[provider])) return false;
            switch (provider) {
                case 'google': url = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`; options = { method: 'GET' }; break;
                case 'openai': url = 'https://api.openai.com/v1/models'; options = { method: 'GET', headers: { 'Authorization': `Bearer ${key}` } }; break;
                case 'anthropic': url = 'https://api.anthropic.com/v1/messages'; options = { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01' }, body: JSON.stringify({ model: "claude-3-haiku-20240307", max_tokens: 1, messages: [] }) }; break;
                default: return false;
            }
            try { const response = await fetch(url, options); if (provider === 'anthropic' && response.status === 400) return true; return response.ok; } catch (error) { console.error("API verification error:", error); return false; }
        }

        startButton.addEventListener('click', async () => {
            if (!apiKey) { setStatusMessage('Please enter an API key.', 'text-red-400'); return; }
            toggleStartButton(true, 'Verifying...'); setStatusMessage('Verifying...', 'text-gray-400');
            const isValid = await verifyApiKey(provider, apiKey);
            if (isValid) {
                setStatusMessage('Success!', 'text-green-400');
                setTimeout(() => {
                    initialState.classList.add('hidden'); chatState.classList.remove('hidden');
                    initializeChat(); toggleStartButton(false, 'Start');
                    setStatusMessage('', ''); setTimeout(() => messageInput.focus(), 0);
                }, 500);
            } else { setStatusMessage('Authentication failed. Please check your key.', 'text-red-400'); toggleStartButton(false, 'Start'); }
        });

        restartChatBtn.addEventListener('click', () => restartChat());
        configureChatBtn.addEventListener('click', () => goToConfig());
        infoWithExamplesBtn.addEventListener('click', () => promptWithExamplesPopup.classList.remove('hidden'));
        closeWithExamplesBtn.addEventListener('click', () => promptWithExamplesPopup.classList.add('hidden'));
        infoWithoutExamplesBtn.addEventListener('click', () => promptWithoutExamplesPopup.classList.remove('hidden'));
        closeWithoutExamplesBtn.addEventListener('click', () => promptWithoutExamplesPopup.classList.add('hidden'));

        // --- Chat Logic ---
        function initializeChat() {
            conversationStep = 0;
            leftChat.innerHTML = ''; rightChat.innerHTML = '';
            leftMessages = []; rightMessages = [];
            handleApiResponse(leftMessages, PROMPT_WITH_EXAMPLES, 'left');
            handleApiResponse(rightMessages, PROMPT_WITHOUT_EXAMPLES, 'right');
            conversationStep = 1;
        }

        function addMessage(side, role, content) {
            const chat = side === 'left' ? leftChat : rightChat; const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] rounded-lg px-4 py-2 ${ role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-100' }`;
            bubble.textContent = content.replace(/\*\*(Therapist|Patient):\*\*/g, '').trim();
            messageDiv.appendChild(bubble); chat.appendChild(messageDiv); chat.scrollTop = chat.scrollHeight;
        }

        function addTypingIndicator(side) {
            const chat = side === 'left' ? leftChat : rightChat; const typingDiv = document.createElement('div');
            typingDiv.id = `${side}Typing`; typingDiv.className = 'flex justify-start fade-in';
            const bubble = document.createElement('div'); bubble.className = 'bg-gray-800 rounded-lg px-4 py-2 flex space-x-1';
            for (let i = 0; i < 3; i++) { const dot = document.createElement('div'); dot.className = 'w-2 h-2 bg-gray-500 rounded-full typing-dot'; bubble.appendChild(dot); }
            typingDiv.appendChild(bubble); chat.appendChild(typingDiv); chat.scrollTop = chat.scrollHeight;
        }

        function removeTypingIndicator(side) { const typing = document.getElementById(`${side}Typing`); if (typing) typing.remove(); }
        
        async function handleApiResponse(messages, prompt, side) {
            const config = API_CONFIGS[provider];
            try {
                addTypingIndicator(side);
                const response = await fetch(config.url, { method: 'POST', headers: config.headers(apiKey), body: JSON.stringify(config.formatRequest(messages, prompt)) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                let responseText = '';
                if ((provider === 'openai' || provider === 'anthropic') && response.body) {
                    const reader = response.body.getReader(); const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read(); if (done) break;
                        const chunk = decoder.decode(value); const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6); if (data === '[DONE]') continue;
                                try {
                                    const parsed = JSON.parse(data);
                                    if (provider === 'openai') { const content = parsed.choices[0]?.delta?.content; if (content) responseText += content; } 
                                    else if (provider === 'anthropic') { if (parsed.type === 'content_block_delta') responseText += parsed.delta.text; }
                                } catch (e) { /* Ignore non-JSON lines */ }
                            }
                        }
                    }
                } else { const data = await response.json(); responseText = config.extractResponse(data); }
                removeTypingIndicator(side); responseText = responseText.replace(/\*\*(Therapist|Patient):\*\*/g, '').trim();
                addMessage(side, 'assistant', responseText);
                if (side === 'left') { leftMessages.push({ role: 'assistant', content: '**Therapist:**\n' + responseText }); } 
                else { rightMessages.push({ role: 'assistant', content: '**Therapist:**\n' + responseText }); }
            } catch (error) { removeTypingIndicator(side); console.error('API Error:', error); addMessage(side, 'assistant', `Error: ${error.message}`); }
        }

        async function sendMessage() {
            const message = messageInput.value.trim(); if (!message) return;
            messageInput.value = ''; addMessage('left', 'user', message); addMessage('right', 'user', message);
            leftMessages.push({ role: 'user', content: '**Patient:**\n' + message }); rightMessages.push({ role: 'user', content: '**Patient:**\n' + message });
            conversationStep++;
            await Promise.all([ handleApiResponse(leftMessages, PROMPT_WITH_EXAMPLES, 'left'), handleApiResponse(rightMessages, PROMPT_WITHOUT_EXAMPLES, 'right') ]);
        }

        // --- State Management Functions ---
        function restartChat() {
            initializeChat();
            setTimeout(() => messageInput.focus(), 0);
        }

        function goToConfig() {
            leftChat.innerHTML = ''; rightChat.innerHTML = '';
            chatState.classList.add('hidden');
            initialState.classList.remove('hidden');
        }

        // --- Input Handlers ---
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    </script>
</body>
</html>